# TRAPO
## システム概要

TRAPOは赤外線距離センサーによってセンサー前方を通過した物体(自動車または歩行者)を検出します。
TRAPOセンサーには赤外線センサーが2つ搭載されています。

赤外線センサーから出力された電圧はロガーによって記録されます。
ロガーに内蔵されたArduino Unoがセンサーの出力電圧をA/D変換し、
時刻とデジタル値をSDカードに保存します。
電圧は50個/秒で記録されます。

電源はモバイルバッテリーを使用します。
21000mAhの容量で3日間の記録が可能です。

TRAPOセンサー（右下の箱にロガーを収納）
![TRAPO](https://raw.githubusercontent.com/kfb01250/trapo/images/TRAPO.JPG)

ロガーとバッテリー
![Logger](https://raw.githubusercontent.com/kfb01250/trapo/images/logger-battery.JPG)


## 交通量の記録

SDカードとモバイルバッテリーを準備します。
SDカードに保存されるログは1時間あたり約6.4MB、1日で約150MBになります。
21000mAhのモバイルバッテリーで約3日間の記録が可能です。

TRAPOセンサーやロガー及びバッテリーを収納する箱は結束バンドで欄干などに固定します。

1. ロガーにSDカードを挿入します。（ケースの構造上SDカードが抜きにくくなっています。ラジオペンチなどを使ってSDカードを引き抜いてください。）
![Insert SD card](https://raw.githubusercontent.com/kfb01250/trapo/images/SDcard.JPG)
2. ロガーにTRAPOセンサーを接続します。
3. ロガーにモバイルバッテリーを接続します。
4. ロガーに電源が供給されると、時刻設定画面が表示されます。
5. 赤いボタンが「決定」です。時刻が異なる場合はこの画面で調整してください。
6. 時刻を設定するとTRAPOセンサーの出力電圧がリアルタイムで表示されます。センサーからの距離が近いと電圧が大きく、遠くなると低くなります。
（50cm以下の近距離の場合も電圧は低くなります。）
7. センサーに手をかざすなどして距離センサーが動作していることを確認してください。
8. 赤いボタンを押すと記録が開始されます。
9. 記録を開始した時刻と現在記録しているファイル名が表示されます。ファイルは1時間ごとに作られます。
10. 記録を終了する時は赤いボタンを長押しします。センサーの出力電圧がリアルタイムで表示されます。
11. この状態でモバイルバッテリーを抜いてください。



## ログデータ

TRAPOセンサーで記録されたデータはCSVファイルとして保存されます。
TRAPOセンサーに向かって右側の距離センサーが1番、左側が2番です。
CSVファイルは1時間ごとにSDカードに保存されます。
ロガーの赤いボタンを長押して記録を終了した場合は
メモリに残っているデータは強制的にSDカードに保存されます。
記録中に電源が切れた場合、メモリに残っている1時間に満たないデータは
SDカードに保存されず、消滅します。

CSVファイルの名前はDDHHMMSS.CSVになります。DDは日、HHは時、MMは分、SSは秒です。



## ログ解析
### 実行環境
#### Python3
Pythonのディストリビューションである
[Anaconda3](https://www.continuum.io/downloads)をインストールします。
Python3.xのバージョンをインストールしてください。

本プログラムはWindows、Mac、Linuxのいずれでも動作します。

#### ログ解析(counter.py)
counter.pyによってロガーで取得したログを解析します。

counter.pyにCSVファイルが入っているフォルダ指定して実行します。
フォルダ内のすべてのCSVファイル全て読み込んで処理します。
CSVファイルが入ったフォルダをcounter.pyと同じフォルダに入れておくと便利です。

counter.pyと同じフォルダに解析結果が保存されます。


### 実行手順 
1. Windowsの場合はスタートメニューから「Anaconda Prompt」を、Mac、Linuxの場合はターミナルを起動します。
2. counter.pyが入ったフォルダに移動します。
3. CSVファイルが入ったフォルダを指定してプログラムを実行します。
```
>python conter.py momiji-20170213
```
4. 通過した物体の時刻と時間ごとの交通量がファイルに保存されます。  
 詳細：momiji-20170213-traffic.csv  
 1時間毎の交通量：momiji-20170213-hourly-traffic.csv

紅葉橋
![Momiji Bridge1](https://raw.githubusercontent.com/kfb01250/trapo/images/momiji-bridge1.JPG)
紅葉橋に取り付けたTRAPO
![Momiji Bridge2](https://raw.githubusercontent.com/kfb01250/trapo/images/momiji-bridge2.JPG)
